name: Auto Merge to Main

on:
  # Trigger when CI passes on testing branch
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - testing

jobs:
  auto-merge:
    name: Create PR and Request Review
    runs-on: ubuntu-latest
    # Only run if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: testing
          fetch-depth: 0

      - name: Check if PR exists
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_EXISTS=$(gh pr list --head testing --base main --json number --jq 'length')
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_pr.outputs.pr_exists == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "üöÄ Merge testing into main" \
            --body "## Automated PR

          This PR was automatically created after all CI checks passed on the \`testing\` branch.

          ### Checks Passed:
          - ‚úÖ Code Quality (Black, isort, Flake8)
          - ‚úÖ Unit Tests
          - ‚úÖ Syntax Validation
          - ‚úÖ Security Scan

          ### Review Required
          Please review the changes before merging to \`main\`.

          ---
          *This PR was auto-generated by GitHub Actions*" \
            --head testing \
            --base main

      - name: Comment on existing PR
        if: steps.check_pr.outputs.pr_exists != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head testing --base main --json number --jq '.[0].number')
          gh pr comment $PR_NUMBER --body "‚úÖ **CI Pipeline passed!** All checks are green. Ready for review and merge."

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Log failure
        run: |
          echo "‚ùå CI Pipeline failed on testing branch"
          echo "The code will NOT be merged to main."
          echo "Please fix the issues and push again."
